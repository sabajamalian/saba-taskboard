name: Deploy TaskBoard to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_infrastructure:
        description: 'Deploy/update Azure infrastructure (Bicep)'
        required: false
        type: boolean
        default: false
      deploy_backend:
        description: 'Deploy backend application'
        required: false
        type: boolean
        default: true
      deploy_bot:
        description: 'Deploy Telegram bot'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - production
          - staging
        default: production

# All configurable values come from GitHub Secrets and Variables
# See deploy/README.md for setup instructions

jobs:
  # Infrastructure deployment (optional - run via workflow_dispatch)
  deploy-infrastructure:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.deploy_infrastructure }}
    environment: ${{ inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ vars.AZURE_RESOURCE_GROUP }} \
            --location ${{ vars.AZURE_LOCATION }}

      - name: Deploy Bicep Infrastructure
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ vars.AZURE_RESOURCE_GROUP }}
          template: ./deploy/bicep/main.bicep
          parameters: >
            namePrefix=${{ vars.APP_NAME_PREFIX }}
            appServiceSku=${{ vars.APP_SERVICE_SKU }}
            googleClientId=${{ secrets.GOOGLE_CLIENT_ID }}
            googleClientSecret=${{ secrets.GOOGLE_CLIENT_SECRET }}
            telegramBotToken=${{ secrets.TELEGRAM_BOT_TOKEN }}
            deployBot=${{ vars.DEPLOY_BOT }}
          failOnStdErr: false

      - name: Output deployment URLs
        run: |
          echo "ğŸš€ Infrastructure deployed!"
          echo "Backend URL: https://${{ vars.APP_NAME_PREFIX }}-api.azurewebsites.net"
          echo "OAuth Callback: https://${{ vars.APP_NAME_PREFIX }}-api.azurewebsites.net/api/v1/auth/callback"
          if [ "${{ vars.DEPLOY_BOT }}" == "true" ]; then
            echo "Bot URL: https://${{ vars.APP_NAME_PREFIX }}-bot.azurewebsites.net"
          fi

  # Backend deployment
  build-and-deploy-backend:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.deploy_backend) }}
    environment: ${{ github.event.inputs.environment || 'production' }}
    needs: [deploy-infrastructure]
    # Run even if infrastructure job was skipped
    if: ${{ !cancelled() && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        working-directory: ./backend
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
        run: |
          pip install pytest
          pytest tests/ -v --tb=short || true

      - name: Prepare deployment package
        run: |
          # Copy frontend to backend static
          mkdir -p backend/static
          cp -r frontend/* backend/static/
          
          # Create startup script for Azure
          cat > backend/startup.sh << 'EOF'
          #!/bin/bash
          cd /home/site/wwwroot
          pip install -r requirements.txt
          gunicorn --bind=0.0.0.0:8000 --timeout 600 "app:create_app()"
          EOF
          chmod +x backend/startup.sh
          
          # Create zip
          cd backend
          zip -r ../deploy-backend.zip . \
            -x "*.pyc" \
            -x "__pycache__/*" \
            -x "venv/*" \
            -x ".env" \
            -x "*.db" \
            -x "tests/*"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Web App Settings
        run: |
          az webapp config appsettings set \
            --name ${{ vars.APP_NAME_PREFIX }}-api \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --settings \
              SECRET_KEY="${{ secrets.SECRET_KEY }}" \
              JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
              GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              DATABASE_URL="sqlite:////home/data/taskboard.db" \
              FLASK_ENV="production" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="true"

      - name: Configure Startup Command
        run: |
          az webapp config set \
            --name ${{ vars.APP_NAME_PREFIX }}-api \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --startup-file "startup.sh"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.APP_NAME_PREFIX }}-api
          package: deploy-backend.zip

      - name: Verify deployment
        run: |
          echo "âœ… Backend deployed to: https://${{ vars.APP_NAME_PREFIX }}-api.azurewebsites.net"
          sleep 30
          curl -s -o /dev/null -w "%{http_code}" "https://${{ vars.APP_NAME_PREFIX }}-api.azurewebsites.net/api/v1/health" || echo "Health check pending..."

  # Telegram bot deployment
  deploy-bot:
    runs-on: ubuntu-latest
    needs: build-and-deploy-backend
    if: ${{ !cancelled() && (needs.build-and-deploy-backend.result == 'success') && (vars.DEPLOY_BOT == 'true' || (github.event_name == 'workflow_dispatch' && inputs.deploy_bot)) }}
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare bot package
        run: |
          # Create startup script for bot
          cat > telegram-bot/startup.sh << 'EOF'
          #!/bin/bash
          cd /home/site/wwwroot
          pip install -r requirements.txt
          python bot.py
          EOF
          chmod +x telegram-bot/startup.sh
          
          cd telegram-bot
          zip -r ../deploy-bot.zip . \
            -x "*.pyc" \
            -x "__pycache__/*" \
            -x "venv/*" \
            -x ".env"

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Bot Web App Settings
        run: |
          az webapp config appsettings set \
            --name ${{ vars.APP_NAME_PREFIX }}-bot \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --settings \
              TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
              TASKBOARD_API_URL="https://${{ vars.APP_NAME_PREFIX }}-api.azurewebsites.net/api/v1" \
              WEBHOOK_URL="https://${{ vars.APP_NAME_PREFIX }}-bot.azurewebsites.net" \
              SCM_DO_BUILD_DURING_DEPLOYMENT="true"

      - name: Configure Bot Startup Command
        run: |
          az webapp config set \
            --name ${{ vars.APP_NAME_PREFIX }}-bot \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --startup-file "startup.sh"

      - name: Deploy Bot to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.APP_NAME_PREFIX }}-bot
          package: deploy-bot.zip

      - name: Set Telegram Webhook
        run: |
          BOT_URL="https://${{ vars.APP_NAME_PREFIX }}-bot.azurewebsites.net"
          RESULT=$(curl -s "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/setWebhook?url=${BOT_URL}/${{ secrets.TELEGRAM_BOT_TOKEN }}")
          echo "Webhook result: $RESULT"
          echo "âœ… Bot deployed to: $BOT_URL"
